seed: 1337
device: cpu
num_threads: 1
num_interop_threads: 1
run: ${now:%y-%m-%d-%H-%M-%S}_${slug:2}
exp:
  name: test
  pos_weight: 30.0
paths:
  root_dir: ${oc.env:PROJECT_ROOT}
  log_dir: ${paths.root_dir}/logs/
  run_dir: ${paths.log_dir}/${exp.name}/${run}
  work_dir: ${hydra:runtime.cwd}
logger:
  _target_: deepmuonreco.logger.Logger
  repo: ${paths.log_dir}
  experiment: ${exp.name}
  run: ${run}
data:
  batch_size: 64
  eval_batch_size: 64
  train_set:
    _target_: deepmuonreco.data.InnerTrackSelectionDataset
    path: data/sanity-check.root
    max_events: 50
  val_set:
    _target_: deepmuonreco.data.InnerTrackSelectionDataset
    path: data/sanity-check.root
    max_events: null
  test_set:
    _target_: deepmuonreco.data.InnerTrackSelectionDataset
    path: data/sanity-check.root
    max_events: null
  train_loader:
    _target_: torch.utils.data.DataLoader
    _partial_: true
    batch_size: ${data.batch_size}
    shuffle: true
    drop_last: true
    num_workers: 0
  val_loader:
    _target_: torch.utils.data.DataLoader
    _partial_: true
    batch_size: ${data.eval_batch_size}
    shuffle: false
    drop_last: false
    num_workers: 0
  test_loader: ${data.val_loader}
preprocessing:
  modules:
  - name: track_norm
    module:
      _target_: deepmuonreco.nn.Normalize
      offset:
      - 0
      - 0
      - 0
      scale:
      - 100
      - 100
      - 3
    in_keys:
    - track
    out_keys:
    - track_prep
  - name: segment_norm
    module:
      _target_: deepmuonreco.nn.Normalize
      offset:
      - 0
      - 0
      - 0
      - 0
      - 0
      - 0
      scale:
      - 750
      - 720
      - 1000
      - 1
      - 1
      - 1
    in_keys:
    - segment
    out_keys:
    - segment_prep
  - name: rechit_norm
    module:
      _target_: deepmuonreco.nn.Normalize
      offset:
      - 0
      - 0
      - 0
      scale:
      - 750
      - 720
      - 1000
    in_keys:
    - rechit
    out_keys:
    - rechit_prep
model:
  module:
    _target_: deepmuonreco.nn.InnerTrackSelectionTransformer
    dim_model: 32
    dim_feedforward: 128
    activation: gelu
    num_heads: 8
    num_layers: 2
    dropout: 0.1
  in_keys:
  - track
  - - pad_masks
    - track
  - segment
  - - pad_masks
    - segment
  - rechit
  - - pad_masks
    - rechit
  out_keys:
  - logits
postprocessing:
  modules:
  - name: score
    module:
      _target_: torch.nn.Sigmoid
    in_keys:
    - logits
    out_keys:
    - score
criterion:
  module:
    _target_: torch.nn.BCEWithLogitsLoss
    pos_weight:
      _target_: torch.Tensor
      data:
      - ${exp.pos_weight}
    reduction: none
  in_keys:
  - logits
  - target
  out_keys:
  - loss
criterion_reduction:
  module:
    _target_: deepmuonreco.nn.MaskedMean
  in_keys:
  - - masks
    - track
  - loss
  out_keys:
  - loss
  inplace: false
optimizer:
  _target_: torch.optim.AdamW
  _partial_: true
  lr: 0.0003
  weight_decay: 0.1
fit:
  num_epochs: 1
  early_stopping_patience: 10
  max_grad_norm: 1.0
metric:
  val:
    postprocessing:
      modules: []
    metric:
      metrics:
        loss:
          metric:
            _target_: deepmuonreco.metrics.MaskingWrapper
            metric:
              _target_: torchmetrics.MeanMetric
              compute_on_cpu: true
          in_keys:
          - - masks
            - track
          - loss
        roc_auc:
          metric:
            _target_: deepmuonreco.metrics.MaskingWrapper
            metric:
              _target_: torchmetrics.classification.BinaryAUROC
              compute_on_cpu: true
          in_keys:
          - - masks
            - track
          - score
          - target
  test:
    postprocessing:
      modules:
      - name: target_to_long
        module:
          _target_: deepmuonreco.nn.ToDtype
          dtype: long
        in_keys:
        - target
        out_keys:
        - target_long
    metric:
      compute_groups:
      - loss
      - - roc_auc
        - roc_curve
      metrics:
        loss: ${metric.val.metric.metrics.loss}
        roc_auc: ${metric.val.metric.metrics.roc_auc}
        roc_curve:
          metric:
            _target_: deepmuonreco.metrics.MaskingWrapper
            metric:
              _target_: torchmetrics.classification.BinaryROC
              compute_on_cpu: true
          in_keys:
          - - masks
            - track
          - score
          - target_long
